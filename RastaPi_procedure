### Burn image using
###
https://archlinuxarm.org/platforms/armv8/broadcom/raspberry-pi-4


### log in as root
###
su root     =>  root


### Init Pacman & update
###
pacman-key --init
pacman-key --populate archlinuxarm
pacman -Syu
    #if certs error:    rm /etc/ssl/certs/ca-certificates.crt && pacman -Syu
pacman-db-upgrade
pacman -Sc


### Change root password
###
passwd   =>   rootpi


### enable SSH root login
###
nano /etc/ssh/sshd_config
=> PermitRootLogin yes 
systemctl restart sshd


### generate rpi ssh keys
###
ssh-keygen  => no password


### copy remote ssh key to rpi
###
[from remote machine] ssh-copy-id root@<IP-ADDRESS>


### remove alarm
###
userdel -r alarm


### install some stuffs
###
pacman -S git python python-pip python-setuptools
pacman -S avahi wget imagemagick
systemctl enable avahi-daemon
systemctl start avahi-daemon

### switch from netctl to NetworkManager
###
pacman -S networkmanager dnsmasq
pacman -R dhcpcd
systemctl stop systemd-resolved
systemctl disable systemd-resolved
rm -rf /etc/resolv.conf
nano /etc/hostname   
=>  rastapi
nano /etc/NetworkManager/NetworkManager.conf
=>  
    [main]
    plugins=keyfile
    dns=dnsmasq

systemctl enable NetworkManager
systemctl start NetworkManager
nmcli con add type ethernet con-name eth0-dhcp ifname eth0
pacman -R netctl


### clone RPi-tools
###
cd /root
git clone https://github.com/KomplexKapharnaum/RPi-tools.git


### copy config.txt
### (check if there is no new config.txt settings that you should keep)
###
cp /root/RPi-tools/config.txt /boot/config.txt
reboot


### dynhost
###
ln -s /root/RPi-tools/dynhost/dynhost.service /etc/systemd/system/dynhost.service
systemctl enable dynhost
systemctl start dynhost


### audioselect 
### (needs dtparam=audio=on inf /boot/config.txt)
###
pacman -S alsa alsa-utils
cp /root/RPi-tools/audioselect/asound.conf /etc/asound.conf
ln -s /root/RPi-tools/audioselect/audioselect.service /etc/systemd/system/audioselect.service
systemctl enable audioselect
systemctl start audioselect


### starter
###
pacman -S python-pydbus
ln -s /root/RPi-tools/starter/starter.service /etc/systemd/system/starter.service
systemctl enable starter
systemctl start starter


### usbmount
###
mkdir /mnt/usb
ln -s /root/RPi-tools/usbmount/mnt-usb.mount /etc/systemd/system/mnt-usb.mount
systemctl enable mnt-usb.mount


### network-magickey
### 
(not sure how to enable)


### data partition
###
-> gparted sd card 
    - shrink system partition to ~6Gb
    - append ~1Gb partition (ext4)
    - boot pi


### rorw
###
nano /boot/cmdline.txt
=> (remove)     rw
=> (insert)     fastboot noswap ro

ln -s /tmp /var/lib/dhcp
ln -s /tmp /var/lib/dhcpcd5

rm -rf /var/run /var/spool /var/lock  /var/lib/systemd/random-seed
ln -s /tmp /var/spool
ln -s /tmp /var/lock
ln -s /run /var/run
#ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf  # not if dnsmasq has been installed with NM


ln -s /tmp/random-seed /var/lib/systemd/random-seed
nano /lib/systemd/system/systemd-random-seed.service
=> (insert before ExecStart)    ExecStartPre=/bin/echo "" >/tmp/random-seed
systemctl daemon-reload
systemctl disable systemd-random-seed

nano /etc/bash.bashrc
=> (append)     source /root/RPi-tools/rorw/rorw.bashrc

nano /etc/bash.bash_logout
=> (append)
    rw
    history -a
    fake-hwclock save
    ro

mkdir /data
nano /etc/fstab
=>
    /dev/mmcblk0p1  /boot   vfat    defaults,ro,errors=remount-ro        0       0
    /dev/mmcblk0p3  /data   ext4    defaults        0       0
    tmpfs   /var/tmp    tmpfs   nodev,nosuid    0   0

reboot
rw
mkdir /data/var
mv /var/log /data/var/
ln -s /data/var/log /var/log

#
# fake-hwclock
#
systemctl disable systemd-timesyncd
pacman -S fake-hwclock
nano /usr/lib/systemd/scripts/fake-hwclock.sh
=> (edit)   STATEFILE="/data/var/fake-hwclock-state"
/usr/lib/systemd/scripts/fake-hwclock.sh save
systemctl enable fake-hwclock fake-hwclock-save.timer


#
# Storage
#
mkdir /data/media
mkdir /data/sync


#
# HPlayer2
#
cd /root
git clone https://github.com/Hemisphere-Project/HPlayer2.git
cd HPlayer2/scripts
=> !!! there is a problem with vulkan.h. Force disable vulkan in waf (dirty fix)
./build.sh

#
# Black Boot
#
cp /etc/systemd/system/getty.target.wants/getty@tty{1,3}.service
    => DefaultInstance=tty3 (instead of tty1)
systemctl disable getty@tty1
nano /boot/cmdline.txt
    => console=tty3 (instead of tty1)
    => (add) logo.nologo vt.global_cursor_default=0 consoleblank=0 quiet loglevel=3 vga=current

#
# Splash
#
ln -s /root/RPi-tools/splashscreen/splashscreen.service /etc/systemd/system/splashscreen.service
systemctl enable splashscreen.service

# 
#  Syncthing
# 
pacman -S syncthing
rm -Rf /data/var/syncthing
syncthing -home=/data/var/syncthing

### TODO
###
- black boot (hide logo and logo to /dev/tty3) + splashcreen ?
- unifi
- router mode config (see RPi-tools/network)
- syncthing
- first boot (after clone):
    * resize2fs /data
    * reset syncthing device id


